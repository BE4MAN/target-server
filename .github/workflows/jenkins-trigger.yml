name: Trigger Jenkins Pipeline

on:
  push:
    branches: [ main ]

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      JENKINS_URL: http://34.22.109.154:8081
      JOB_NAME: be4man-target-server
      JENKINS_USER: be4man

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract DEPLOYMENT_ID from commit message
        id: parse
        run: |
          set -e
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "Last commit message:"
          echo "--------------------------------"
          echo "$COMMIT_MSG"
          echo "--------------------------------"

          DEPLOYMENT_ID=$(printf "%s" "$COMMIT_MSG" | grep -oE 'DEPLOYMENT_ID=[0-9]+' | head -n1 | cut -d= -f2 || true)

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "::error::DEPLOYMENT_ID not found in commit message. Please include [DEPLOYMENT_ID=123] in the merge title/message."
            exit 1
          fi

          echo "Parsed DEPLOYMENT_ID=$DEPLOYMENT_ID"
          echo "deployment_id=$DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"
          
      - name: Get Crumb
        id: crumb
        run: |
          set -e
          echo "Requesting Jenkins crumb..."
          RESPONSE=$(curl -s -u "${JENKINS_USER}:${{ secrets.JENKINS_TOKEN }}" \
            "${JENKINS_URL}/crumbIssuer/api/json" || true)
          echo "Crumb response: $RESPONSE"

          CRUMB=$(printf "%s" "$RESPONSE" | sed -n 's/.*"crumb":"\([^"]*\)".*/\1/p' || true)

          if [ -z "$CRUMB" ]; then
            echo "No crumb found (CRUMB empty). If Jenkins has CSRF disabled this is expected."
          else
            echo "Crumb extracted (length=$(printf "%s" "$CRUMB" | wc -c))"
          fi

          echo "crumb=$CRUMB" >> "$GITHUB_OUTPUT"

      - name: Trigger Jenkins (with crumb & DEPLOYMENT_ID) - DEBUG
        run: |
          set -e
          DEPLOYMENT_ID="${{ steps.parse.outputs.deployment_id }}"
          echo "Triggering Jenkins with DEPLOYMENT_ID=$DEPLOYMENT_ID"

          URL="${JENKINS_URL}/job/${JOB_NAME}/buildWithParameters?delay=0sec&DEPLOYMENT_ID=${DEPLOYMENT_ID}"
          echo "Request URL: $URL"

          # build curl args
          CURL_ARGS=(
            -s
            -w "\nHTTP_STATUS=%{http_code}\n"
            -X POST
            -u "${JENKINS_USER}:${{ secrets.JENKINS_TOKEN }}"
          )

          if [ -n "${{ steps.crumb.outputs.crumb }}" ]; then
            echo "Using Jenkins Crumb"
            CURL_ARGS+=(-H "Jenkins-Crumb: ${{ steps.crumb.outputs.crumb }}")
          else
            echo "No crumb set â€“ calling Jenkins without CSRF header"
          fi

          echo "=== Sending request to Jenkins ==="
          RESPONSE=$(curl "${CURL_ARGS[@]}" "$URL")
          echo "=== Jenkins raw response ==="
          echo "$RESPONSE"
          echo "============================"

          HTTP_STATUS=$(echo "$RESPONSE" | grep 'HTTP_STATUS=' | sed 's/HTTP_STATUS=//')
          echo "HTTP_STATUS=$HTTP_STATUS"

          if [ "$HTTP_STATUS" != "201" ] && [ "$HTTP_STATUS" != "302" ] && [ "$HTTP_STATUS" != "200" ]; then
            echo "Failed to trigger Jenkins (non-success HTTP status)"
            exit 1
          fi

name: PR merged -> notify be4man-server

on:
  pull_request:
    types: [closed]
    branches:
      - '*develop*'

jobs:
  notify:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Build minimal payload (write to body.json)
        run: |
          set -euo pipefail
          PR_NUMBER='${{ github.event.pull_request.number }}'
          BRANCH='${{ github.event.pull_request.head.ref }}'
          REPO_URL='${{ github.event.pull_request.head.repo.html_url }}'
          GITHUB_EMAIL='${{ github.event.pull_request.user.email || '' }}'
          AUTHOR_ID='${{ github.event.pull_request.user.id }}'
          printf '{"pr_number":%s,"branch":"%s","repository_url":"%s","github_email":"%s","githubId":%s}' \
            "$PR_NUMBER" "$BRANCH" "$REPO_URL" "$GITHUB_EMAIL" "$AUTHOR_ID" > body.json
          perl -0777 -pe 's/\n\z//' -i -- body.json

      - name: Sign and POST to be4man-server
        env:
          WEBHOOK_URL: ${{ secrets.BE4MAN_WEBHOOK_URLL }}
          WEBHOOK_SECRET: ${{ secrets.BE4MAN_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          SIG=$(openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary body.json | xxd -p -c 256)
          curl -sS -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -H 'X-GitHub-Event: pull_request' \
            -H "X-Hub-Signature-256: sha256=${SIG}" \
            --data-binary @body.json

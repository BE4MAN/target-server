name: PR merged -> notify be4man-server
on:
  pull_request:
    types: [closed]
    branches:
      - '*develop*'

jobs:
  notify:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Debug PR info
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }}"
          echo "Repo URL: ${{ github.event.pull_request.head.repo.html_url }}"
          echo "User Email: ${{ github.event.pull_request.user.email }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"

      - name: Build and send payload
        env:
          WEBHOOK_URL: ${{ secrets.BE4MAN_WEBHOOK_URLL }}
          WEBHOOK_SECRET: ${{ secrets.BE4MAN_WEBHOOK_SECRET }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH: ${{ github.event.pull_request.head.ref }}
          REPO_URL: ${{ github.event.pull_request.head.repo.html_url }}
          GITHUB_EMAIL: ${{ github.event.pull_request.user.email }}
        run: |
          set -euxo pipefail
   
          jq -n \
            --argjson pr_number "$PR_NUMBER" \
            --arg branch "$BRANCH" \
            --arg repository_url "$REPO_URL" \
            --arg github_email "${GITHUB_EMAIL:-}" \
            '{
              pr_number: $pr_number,
              branch: $branch,
              repository_url: $repository_url,
              github_email: $github_email
            }' > body.json
          
          echo "=== Generated JSON ==="
          cat body.json
          echo ""
          
          perl -0777 -pe 's/\n\z//' -i body.json
          
          SIG=$(openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary body.json | xxd -p -c 256)
          echo "=== HMAC Signature ==="
          echo "sha256=$SIG"
          echo ""
          
          echo "=== Sending to $WEBHOOK_URL ==="
          HTTP_CODE=$(curl -w "%{http_code}" -o response.txt -sS -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -H 'X-GitHub-Event: pull_request' \
            -H "X-Hub-Signature-256: sha256=${SIG}" \
            --data-binary @body.json)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response:"
          cat response.txt
          echo ""
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "❌ Webhook failed with status $HTTP_CODE"
            exit 1
          fi
          
          echo "✅ Webhook sent successfully"

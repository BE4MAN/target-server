name: Test Webhook Connectivity
on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test 1 - Check secrets exist
        run: |
          echo "Checking secrets..."
          if [ -z "${{ secrets.BE4MAN_WEBHOOK_URLL }}" ]; then
            echo "❌ BE4MAN_WEBHOOK_URL is NOT set"
            exit 1
          else
            echo "✅ BE4MAN_WEBHOOK_URL is set"
          fi
          
          if [ -z "${{ secrets.BE4MAN_WEBHOOK_SECRET }}" ]; then
            echo "❌ BE4MAN_WEBHOOK_SECRET is NOT set"
            exit 1
          else
            echo "✅ BE4MAN_WEBHOOK_SECRET is set"
          fi

      - name: Test 2 - Try to reach URL
        env:
          WEBHOOK_URL: ${{ secrets.BE4MAN_WEBHOOK_URLL }}
        run: |
          echo "Testing connection to: ${WEBHOOK_URL:0:30}..."
          
          # DNS 해석 테스트
          DOMAIN=$(echo $WEBHOOK_URL | sed -e 's|https\?://||' -e 's|/.*||')
          echo "Domain: $DOMAIN"
          
          if nslookup $DOMAIN; then
            echo "✅ DNS resolution OK"
          else
            echo "❌ DNS resolution FAILED"
          fi
          
          # 실제 연결 테스트
          if curl -v --max-time 10 "$WEBHOOK_URL" 2>&1 | head -n 20; then
            echo "✅ Connection attempt made (check output above)"
          else
            echo "❌ Connection FAILED"
          fi

      - name: Test 3 - Send test request
        env:
          WEBHOOK_URL: ${{ secrets.BE4MAN_WEBHOOK_URLL }}
          WEBHOOK_SECRET: ${{ secrets.BE4MAN_WEBHOOK_SECRET }}
        run: |
          echo '{"test":"ping"}' > test.json
          SIG=$(openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" -binary test.json | xxd -p -c 256)
          
          echo "Sending test request..."
          curl -v -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -H "X-Hub-Signature-256: sha256=${SIG}" \
            --data-binary @test.json \
            2>&1 | tee output.log
          
          echo ""
          echo "=== Full output ==="
          cat output.log
